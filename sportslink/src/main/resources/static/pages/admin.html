<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportsLink - Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/admin.css">

    <!-- Pagination small CSS -->
    <style>
        /* Permite tabela + paginação ficarem alinhadas verticalmente */
        .table-container {
            display: flex;
            flex-direction: column;
        }

        .pagination-controls {
            margin-top: 1.25rem;        /* mais espaço em cima */
            padding-bottom: 0.75rem;    /* mais espaço em baixo */
            display: flex;
            gap: 0.75rem;               /* mais espaçamento entre botões */
            align-items: center;
            justify-content: center;    /* centra a paginação */
            font-size: 0.9rem;
            width: 100%;
        }

        .pagination-controls .pagination-info {
            color: #64748b;
            margin: 0 0.5rem;
        }
    </style>
</head>

<body>

    <nav class="sidebar">
        <a href="/" class="logo">
            SportsLink Admin
        </a>
        <div id="nav-users" class="nav-link active" onclick="switchTab('users')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            Users
        </div>
        <div id="nav-facilities" class="nav-link" onclick="switchTab('facilities')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            Facilities
        </div>
        <div id="nav-monitoring" class="nav-link" onclick="switchTab('monitoring')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Monitoring
        </div>
        <div id="nav-stats" class="nav-link" onclick="switchTab('stats')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
            </svg>
            Stats (Charts)
        </div>
    </nav>

    <main class="main-content">
        <header>
            <h1 id="page-title">User Management</h1>
            <div class="user-menu">
                <span style="font-weight: 600;">Admin</span>
                <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
            </div>
        </header>

        <!-- Users Section -->
        <section id="view-users" class="view-section active">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="6" class="loading">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
                <div id="users-pagination" class="pagination-controls"></div>
            </div>
        </section>

        <!-- Facilities Section -->
        <section id="view-facilities" class="view-section">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Owner</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="facilities-table-body">
                        <tr>
                            <td colspan="5" class="loading">Loading facilities...</td>
                        </tr>
                    </tbody>
                </table>
                <div id="facilities-pagination" class="pagination-controls"></div>
            </div>
        </section>


        <!-- Monitoring Section -->
        <section id="view-monitoring" class="view-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="stat-users">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Facilities</div>
                    <div class="stat-value" id="stat-facilities">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Rentals</div>
                    <div class="stat-value" id="stat-rentals">-</div>
                </div>
            </div>

            <h2 style="margin-bottom: 1rem;">Recent Rentals</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Facility</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rentals-table-body">
                        <tr>
                            <td colspan="8" class="loading">Loading rentals...</td>
                        </tr>
                    </tbody>
                </table>
                <div id="rentals-pagination" class="pagination-controls"></div>
            </div>
        </section>

        <!-- Stats Section -->
        <section id="view-stats" class="view-section">
            <h2>Usage Statistics</h2>
            <div class="charts-container">
                <div class="chart-wrapper">
                    <h3>Rentals by Sport</h3>
                    <div class="chart-canvas-container">
                        <canvas id="rentalsBySportChart"></canvas>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <h3>Rentals by Status</h3>
                    <div class="chart-canvas-container">
                        <canvas id="rentalsByStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Details Modal -->
        <div id="detailsModal" class="modal-overlay" onclick="closeModal(event)">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle" class="modal-title">Details</h2>
                    <button class="close-btn" onclick="closeModalBtn()">×</button>
                </div>
                <div id="modalBody">
                    <!-- Content injected via JS -->
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = '/api/admin';
        let token = localStorage.getItem('token');
        let sportChart = null;
        let statusChart = null;

        // Pagination state
        const USERS_PAGE_SIZE = 5;
        const FACILITIES_PAGE_SIZE = 10;
        const RENTALS_PAGE_SIZE = 10;

        let usersData = [];
        let usersPage = 1;

        let facilitiesData = [];
        let facilitiesPage = 1;

        let rentalsData = [];
        let rentalsPage = 1;

        // Auth Check
        if (!token) {
            window.location.href = '/index.html';
        }

        const headers = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        function switchTab(tab) {
            // Update Nav
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');

            // Update View
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');

            // Update Title
            const titles = {
                'users': 'User Management',
                'facilities': 'Facility Management',
                'monitoring': 'System Monitoring',
                'stats': 'Statistics'
            };
            document.getElementById('page-title').textContent = titles[tab];

            // Load Data
            if (tab === 'users') loadUsers();
            if (tab === 'facilities') loadFacilities();
            if (tab === 'monitoring') loadMonitoring();
            if (tab === 'stats') loadStats();
        }

        // -------- Users --------
        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/users`, { headers });
                if (!res.ok) throw new Error('Failed to load users');
                usersData = await res.json();
                usersPage = 1;
                renderUsersTable();
            } catch (err) {
                console.error(err);
            }
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');

            if (!usersData || usersData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="loading">No users found.</td></tr>`;
                document.getElementById('users-pagination').innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(usersData.length / USERS_PAGE_SIZE);
            if (usersPage > totalPages) usersPage = totalPages;

            const start = (usersPage - 1) * USERS_PAGE_SIZE;
            const end = start + USERS_PAGE_SIZE;
            const pageItems = usersData.slice(start, end);

            tbody.innerHTML = pageItems.map(user => `
                <tr>
                    <td>#${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.roles.map(r => `<span class="badge badge-info">${r}</span>`).join(' ')}</td>
                    <td>
                        <span class="badge ${user.active ? 'badge-success' : 'badge-danger'}">
                            ${user.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button onclick="viewUser(${user.id})" class="btn btn-secondary btn-sm" style="margin-right: 5px;">View</button>
                        <button onclick="toggleUserStatus(${user.id}, ${!user.active})" class="btn btn-sm ${user.active ? 'btn-danger' : 'btn-primary'}">
                            ${user.active ? 'Ban' : 'Unban'}
                        </button>
                    </td>
                </tr>
            `).join('');

            renderUsersPagination(totalPages);
        }

        function renderUsersPagination(totalPages) {
            const container = document.getElementById('users-pagination');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <button class="btn btn-secondary btn-sm"
                        onclick="changeUsersPage(${usersPage - 1})"
                        ${usersPage === 1 ? 'disabled' : ''}>
                    Previous
                </button>
                <span class="pagination-info">Page ${usersPage} of ${totalPages}</span>
                <button class="btn btn-secondary btn-sm"
                        onclick="changeUsersPage(${usersPage + 1})"
                        ${usersPage === totalPages ? 'disabled' : ''}>
                    Next
                </button>
            `;
        }

        function changeUsersPage(page) {
            const totalPages = Math.ceil(usersData.length / USERS_PAGE_SIZE);
            if (page < 1 || page > totalPages) return;
            usersPage = page;
            renderUsersTable();
        }

        async function viewUser(id) {
            try {
                const res = await fetch(`${API_BASE}/users/${id}`, { headers });
                const user = await res.json();

                const html = `
                    <div class="detail-row"><span class="detail-label">Name:</span> <span class="detail-value">${user.name}</span></div>
                    <div class="detail-row"><span class="detail-label">Email:</span> <span class="detail-value">${user.email}</span></div>
                    <div class="detail-row"><span class="detail-label">Phone:</span> <span class="detail-value">${user.phone || 'N/A'}</span></div>
                    <div class="detail-row"><span class="detail-label">Roles:</span> <span class="detail-value">${user.roles.join(', ')}</span></div>
                    <div class="detail-row"><span class="detail-label">Status:</span> <span class="detail-value">${user.active ? 'Active' : 'Banned'}</span></div>
                    <div class="detail-row"><span class="detail-label">Created At:</span> <span class="detail-value">${new Date(user.createdAt).toLocaleString()}</span></div>
                `;
                openModal('User Details', html);
            } catch (err) {
                console.error(err);
                alert('Failed to load user details');
            }
        }

        async function toggleUserStatus(id, active) {
            if (!confirm(`Are you sure you want to ${active ? 'activate' : 'deactivate'} this user?`)) return;
            try {
                const res = await fetch(`${API_BASE}/users/${id}/status?active=${active}`, {
                    method: 'PUT',
                    headers
                });
                if (res.ok) loadUsers();
                else alert('Failed to update status');
            } catch (err) {
                console.error(err);
            }
        }

        // -------- Facilities --------
        async function loadFacilities() {
            try {
                const res = await fetch(`${API_BASE}/facilities`, { headers });
                facilitiesData = await res.json();
                facilitiesPage = 1;
                renderFacilitiesTable();
            } catch (err) {
                console.error(err);
            }
        }

        function renderFacilitiesTable() {
            const tbody = document.getElementById('facilities-table-body');

            if (!facilitiesData || facilitiesData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="loading">No facilities found.</td></tr>`;
                document.getElementById('facilities-pagination').innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(facilitiesData.length / FACILITIES_PAGE_SIZE);
            if (facilitiesPage > totalPages) facilitiesPage = totalPages;

            const start = (facilitiesPage - 1) * FACILITIES_PAGE_SIZE;
            const end = start + FACILITIES_PAGE_SIZE;
            const pageItems = facilitiesData.slice(start, end);

            tbody.innerHTML = pageItems.map(f => `
                <tr>
                    <td>#${f.id}</td>
                    <td>${f.name}</td>
                    <td>${f.owner ? f.owner.name : 'Unknown'}</td>
                    <td>${f.address}</td>
                    <td>
                        <button onclick="viewFacility(${f.id})" class="btn btn-secondary btn-sm" style="margin-right: 5px;">View</button>
                        <button onclick="deleteFacility(${f.id})" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                </tr>
            `).join('');

            renderFacilitiesPagination(totalPages);
        }

        function renderFacilitiesPagination(totalPages) {
            const container = document.getElementById('facilities-pagination');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <button class="btn btn-secondary btn-sm"
                        onclick="changeFacilitiesPage(${facilitiesPage - 1})"
                        ${facilitiesPage === 1 ? 'disabled' : ''}>
                    Previous
                </button>
                <span class="pagination-info">Page ${facilitiesPage} of ${totalPages}</span>
                <button class="btn btn-secondary btn-sm"
                        onclick="changeFacilitiesPage(${facilitiesPage + 1})"
                        ${facilitiesPage === totalPages ? 'disabled' : ''}>
                    Next
                </button>
            `;
        }

        function changeFacilitiesPage(page) {
            const totalPages = Math.ceil(facilitiesData.length / FACILITIES_PAGE_SIZE);
            if (page < 1 || page > totalPages) return;
            facilitiesPage = page;
            renderFacilitiesTable();
        }

        async function viewFacility(id) {
            try {
                const res = await fetch(`${API_BASE}/facilities/${id}`, { headers });
                const f = await res.json();

                let equipmentsHtml = '<span class="text-muted">No equipment listed</span>';
                if (f.equipments && f.equipments.length > 0) {
                    equipmentsHtml = `<ul class="equipment-list">
                        ${f.equipments.map(e => `
                            <li class="equipment-item">
                                <span>${e.name} (${e.type})</span>
                                <span>${e.quantity} units</span>
                            </li>
                        `).join('')}
                    </ul>`;
                }

                const html = `
                    <div class="detail-row"><span class="detail-label">Name:</span> <span class="detail-value">${f.name}</span></div>
                    <div class="detail-row"><span class="detail-label">Owner:</span> <span class="detail-value">${f.owner ? f.owner.name : 'Unknown'}</span></div>
                    <div class="detail-row"><span class="detail-label">City:</span> <span class="detail-value">${f.city}</span></div>
                    <div class="detail-row"><span class="detail-label">Address:</span> <span class="detail-value">${f.address}</span></div>
                    <div class="detail-row"><span class="detail-label">Price/Hour:</span> <span class="detail-value">${f.pricePerHour}€</span></div>
                    <div class="detail-row"><span class="detail-label">Sports:</span> <span class="detail-value">${f.sports.join(', ')}</span></div>
                    <div class="detail-row"><span class="detail-label">Rating:</span> <span class="detail-value">${f.rating}/5.0</span></div>
                    <div class="detail-row"><span class="detail-label">Status:</span> <span class="detail-value">${f.status}</span></div>
                    <h3 style="margin-top: 1.5rem; font-size: 1.1rem;">Equipments</h3>
                    ${equipmentsHtml}
                `;
                openModal('Facility Details', html);
            } catch (err) {
                console.error(err);
                alert('Failed to load facility details');
            }
        }

        async function deleteFacility(id) {
            if (!confirm('Are you sure you want to delete this facility? This cannot be undone.')) return;
            try {
                const res = await fetch(`${API_BASE}/facilities/${id}`, {
                    method: 'DELETE',
                    headers
                });
                if (res.ok) loadFacilities();
                else alert('Failed to delete facility');
            } catch (err) {
                console.error(err);
            }
        }

        // -------- Monitoring / Rentals --------
        async function loadMonitoring() {
            try {
                // Stats
                const statsRes = await fetch(`${API_BASE}/stats`, { headers });
                const stats = await statsRes.json();
                document.getElementById('stat-users').innerText = stats.totalUsers;
                document.getElementById('stat-facilities').innerText = stats.totalFacilities;
                document.getElementById('stat-rentals').innerText = stats.totalRentals;

                // Rentals
                const rentalsRes = await fetch(`${API_BASE}/rentals`, { headers });
                rentalsData = await rentalsRes.json();

                // Sorting rentals by date descending for better visibility
                rentalsData.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
                rentalsPage = 1;
                renderRentalsTable();
            } catch (err) {
                console.error(err);
            }
        }

        function renderRentalsTable() {
            const tbody = document.getElementById('rentals-table-body');

            if (!rentalsData || rentalsData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="loading">No rentals found.</td></tr>`;
                document.getElementById('rentals-pagination').innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(rentalsData.length / RENTALS_PAGE_SIZE);
            if (rentalsPage > totalPages) rentalsPage = totalPages;

            const start = (rentalsPage - 1) * RENTALS_PAGE_SIZE;
            const end = start + RENTALS_PAGE_SIZE;
            const pageItems = rentalsData.slice(start, end);

            tbody.innerHTML = pageItems.map(r => `
                <tr>
                    <td>#${r.id}</td>
                    <td>${r.user ? r.user.name : 'Unknown'}</td>
                    <td>${r.facility ? r.facility.name : 'Unknown'}</td>
                    <td>${new Date(r.startTime).toLocaleDateString()}</td>
                    <td><span class="badge ${getStatusBadge(r.status)}">${r.status}</span></td>
                    <td>${formatPrice(r.totalPrice)}</td>
                    <td>
                        ${r.status === 'CONFIRMED'
                            ? `<button onclick="cancelRental(${r.id})" class="btn btn-danger btn-sm">Cancel</button>`
                            : '<span class="text-muted">-</span>'}
                    </td>
                </tr>
            `).join('');

            renderRentalsPagination(totalPages);
        }

        function renderRentalsPagination(totalPages) {
            const container = document.getElementById('rentals-pagination');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <button class="btn btn-secondary btn-sm"
                        onclick="changeRentalsPage(${rentalsPage - 1})"
                        ${rentalsPage === 1 ? 'disabled' : ''}>
                    Previous
                </button>
                <span class="pagination-info">Page ${rentalsPage} of ${totalPages}</span>
                <button class="btn btn-secondary btn-sm"
                        onclick="changeRentalsPage(${rentalsPage + 1})"
                        ${rentalsPage === totalPages ? 'disabled' : ''}>
                    Next
                </button>
            `;
        }

        function changeRentalsPage(page) {
            const totalPages = Math.ceil(rentalsData.length / RENTALS_PAGE_SIZE);
            if (page < 1 || page > totalPages) return;
            rentalsPage = page;
            renderRentalsTable();
        }

        async function cancelRental(id) {
            if (!confirm('Are you sure you want to cancel this booking?')) return;
            try {
                const res = await fetch(`${API_BASE}/rentals/${id}/cancel`, {
                    method: 'POST',
                    headers
                });
                if (res.ok) {
                    loadMonitoring();
                    loadStats(); // Update charts too
                } else {
                    alert('Failed to cancel rental');
                }
            } catch (err) {
                console.error(err);
            }
        }

        function getStatusBadge(status) {
            if (status === 'CONFIRMED') return 'badge-success';
            if (status === 'CANCELLED') return 'badge-danger';
            return 'badge-warning';
        }

        function formatPrice(price) {
            if (price === null || price === undefined) return '<span class="text-muted">N/A</span>';
            return price.toFixed(2) + '€';
        }

        // -------- Stats / Charts --------
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats/charts`, { headers });
                const data = await res.json();

                renderSportChart(data.rentalsBySport);
                renderStatusChart(data.rentalsByStatus);
            } catch (err) {
                console.error(err);
            }
        }

        function renderSportChart(data) {
            const ctx = document.getElementById('rentalsBySportChart');
            if (sportChart) sportChart.destroy();

            sportChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Rentals',
                        data: Object.values(data),
                        backgroundColor: ['#4f46e5', '#ef4444', '#22c55e', '#f59e0b', '#06b6d4', '#8b5cf6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderStatusChart(data) {
            const ctx = document.getElementById('rentalsByStatusChart');
            if (statusChart) statusChart.destroy();

            statusChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Rentals',
                        data: Object.values(data),
                        backgroundColor: '#64748b',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }

        // Modal Functions
        function openModal(title, html) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').classList.add('active');
        }

        function closeModal(e) {
            if (e.target === document.getElementById('detailsModal')) {
                closeModalBtn();
            }
        }

        function closeModalBtn() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        }

        // Initial Load
        loadUsers();
    </script>
</body>

</html>