<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SportsLink — Profile</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../css/styles.css" rel="stylesheet">
    
    <script>
        // Verificar autenticação ANTES de carregar a página
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/index.html';
            }
        })();
    </script>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="main_page_user.html">
                <i class="material-icons me-2 text-accent">sports_soccer</i>
                <span class="text-gradient fw-bold fs-4">SportsLink</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link fw-medium" href="main_page_user.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-medium" href="#reservas">My Bookings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-medium" href="#explorar">Explore Fields</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-medium" href="#favoritos">Favorites</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button id="profileBtn"
                            class="profile-icon d-flex align-items-center justify-content-center text-white fw-bold dropdown-toggle"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            U
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileBtn">
                            <li><a class="dropdown-item" href="#" id="profileManage">Profile</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#" id="logoutBtn">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Profile Section -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-accent text-white">
                        <h4 class="mb-0">My Profile</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Name</label>
                                    <p id="userName" class="form-control-plaintext">Loading...</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <p id="userEmail" class="form-control-plaintext">Loading...</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Phone</label>
                                    <p id="userPhone" class="form-control-plaintext">Loading...</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Role</label>
                                    <p id="userRole" class="form-control-plaintext">Loading...</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Status</label>
                                    <p id="userActive" class="form-control-plaintext">Loading...</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Member Since</label>
                                    <p id="userCreatedAt" class="form-control-plaintext">Loading...</p>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Total Rentals</label>
                                    <p id="userRentalsCount" class="form-control-plaintext">Loading...</p>
                                </div>
                            </div>
                            <div class="col-md-6" id="facilitiesSection" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Facilities Owned</label>
                                    <p id="userFacilitiesCount" class="form-control-plaintext">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <!-- Custom JS -->
    <script src="../js/auth.js"></script>
    <script>
        // Profile page script
        document.addEventListener('DOMContentLoaded', async () => {
            // Update profile button initial (mantemos simples por agora)
            const profileBtn = document.getElementById('profileBtn');
            const token = localStorage.getItem('token');
            if (token) {
                // Poderíamos decodificar JWT aqui, mas neste momento não é necessário
            }

            // Bind logout (função vem de auth.js)
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }

            // Load profile data
            await loadProfile();
        });

        async function loadProfile() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '../index.html';
                return;
            }

            try {
                const res = await fetch('/api/auth/profile', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!res.ok) {
                    if (res.status === 401) {
                        // Token inválido/expirado → faz logout e volta ao login
                        logout();
                        return;
                    }
                    throw new Error('Failed to load profile');
                }

                const user = await res.json();

                // Campos básicos
                document.getElementById('userName').textContent = user.name || 'N/A';
                document.getElementById('userEmail').textContent = user.email || 'N/A';
                document.getElementById('userPhone').textContent = user.phone || 'N/A';
                document.getElementById('userRole').textContent = user.role || 'N/A';
                document.getElementById('userActive').textContent = user.active ? 'Active' : 'Inactive';
                document.getElementById('userCreatedAt').textContent =
                    user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';

                // Contagem de rentals (novo campo rentalsCount do UserProfileDTO)
                const rentalsCount = typeof user.rentalsCount === 'number' ? user.rentalsCount : 0;
                document.getElementById('userRentalsCount').textContent = rentalsCount;

                // Secção de facilities apenas para OWNER, com facilitiesCount
                if (user.role === 'OWNER') {
                    const facilitiesSection = document.getElementById('facilitiesSection');
                    if (facilitiesSection) {
                        facilitiesSection.style.display = 'block';
                    }
                    const facilitiesCount = typeof user.facilitiesCount === 'number' ? user.facilitiesCount : 0;
                    const facilitiesCountEl = document.getElementById('userFacilitiesCount');
                    if (facilitiesCountEl) {
                        facilitiesCountEl.textContent = facilitiesCount;
                    }
                } else {
                    const facilitiesSection = document.getElementById('facilitiesSection');
                    if (facilitiesSection) {
                        facilitiesSection.style.display = 'none';
                    }
                }

                // Update profile initial
                const initial = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                const profileBtn = document.getElementById('profileBtn');
                if (profileBtn) {
                    profileBtn.textContent = initial;
                }

            } catch (err) {
                console.error('Error loading profile:', err);
                if (typeof showBootstrapToast === 'function') {
                    showBootstrapToast('Error loading profile', 'danger');
                }
            }
        }
    </script>
</body>

</html>
